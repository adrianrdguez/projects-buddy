const express = require('express');
const cors = require('cors');
const { exec } = require('child_process');

const app = express();
const port = 3001;

app.use(cors());
app.use(express.json());

// Endpoint principal: enviar task a Cursor
app.post('/send-to-cursor', async (req, res) => {
  try {
    const { prompt, targetFile, projectName } = req.body;
    
    console.log(`ðŸš€ Enviando task a Cursor...`);
    console.log(`ðŸ“ Archivo objetivo: ${targetFile || 'N/A'}`);
    console.log(`ðŸ“ Prompt: ${prompt.substring(0, 100)}...`);
    
    // 1. Construir prompt mejorado
    const enhancedPrompt = buildEnhancedPrompt(prompt, targetFile, projectName);
    
    // 2. Abrir Cursor automÃ¡ticamente
    const platform = process.platform;
    let openCommand = platform === 'darwin' ? 'open -a Cursor' : 
                     platform === 'win32' ? 'start cursor' : 'cursor';
    
    exec(openCommand, (error) => {
      if (error) {
        console.log('âš ï¸  Cursor no se pudo abrir automÃ¡ticamente, Ã¡brelo manualmente');
      } else {
        console.log('âœ… Cursor abierto');
      }
    });
    
    // 3. Mostrar prompt en consola para copiado manual
    console.log('\nðŸ“‹ COPIA ESTE PROMPT EN CURSOR:');
    console.log('=====================================');
    console.log(enhancedPrompt);
    console.log('=====================================\n');
    
    res.json({ 
      success: true, 
      message: 'âœ… Cursor abierto! Revisa la consola y copia el prompt manualmente (Cmd+L para abrir chat)',
      enhancedPrompt 
    });
    
  } catch (error) {
    console.error('âŒ Error:', error);
    res.status(500).json({ 
      success: false, 
      error: error.message 
    });
  }
});

function buildEnhancedPrompt(basePrompt, targetFile, projectName) {
  let enhancedPrompt = `# ðŸŽ¯ Task from AI Planner\n\n`;
  
  if (projectName) {
    enhancedPrompt += `**Project:** ${projectName}\n`;
  }
  
  if (targetFile) {
    enhancedPrompt += `**Target file:** \`${targetFile}\`\n\n`;
  }
  
  enhancedPrompt += `**Instructions:**\n${basePrompt}\n\n`;
  enhancedPrompt += `**Additional requirements:**\n`;
  enhancedPrompt += `- Use TypeScript with proper type definitions\n`;
  enhancedPrompt += `- Include error handling and loading states\n`;
  enhancedPrompt += `- Follow React/Next.js best practices\n`;
  enhancedPrompt += `- Add basic comments for complex logic\n`;
  enhancedPrompt += `- Ensure code is production-ready\n\n`;
  enhancedPrompt += `*Generated by AI Planner - ${new Date().toLocaleTimeString()}*`;
  
  return enhancedPrompt;
}

app.get('/health', (req, res) => {
  res.json({ status: 'ok', message: 'Server running!' });
});

app.listen(port, () => {
  console.log('ðŸš€ Cursor Integration Server (Simple) iniciado!');
  console.log(`ðŸ“¡ Servidor corriendo en http://localhost:${port}`);
  console.log('\nðŸ“‹ Workflow:');
  console.log('1. EnvÃ­a request desde el HTML');
  console.log('2. Se abre Cursor automÃ¡ticamente');
  console.log('3. Copia el prompt de la consola');
  console.log('4. Pega en Cursor con Cmd+L > Cmd+V');
});